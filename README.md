#spring-cloud全家桶
##1.简介
###1.1官方说明：  
>SpringCloud，基于SpringBoot提供了一套微服务解决方案，包括服务注册与发现，
配置中心，全链路监控，服务网关，负载均衡，熔断器等组件，除了基于NetFlix的
开源组件做高度抽象封装之外，还有一些选型中立的开源组件。  
>SpringCloud利用SpringBoot的开发便利性巧妙地简化了分布式系统基础设施的开
发，SpringCloude为开发人员提供了快速构建分布式系统的一些工具，包括配置管
理、服务发现、断路器、路由、微代理、事件总线、全局锁、决策竞选、分布式会话
等等，它们都可以用SpringBoot的开发风格做到一键启动和部署。  
>SpringBoot并没有重复制造轮子，它只是将目前各公司开发比较成熟、经得起实际
考验的服务框架组合起来，通过SpringBoot风格进行再封装屏蔽掉了复杂的配置和
实现原理，最终给开发者留出了一套简单易懂、易部署和易维护的分布式系统开发
工具包SpringCloude=分布式微服务架构下的一站式解决方案，是各个微服务架构地
落地技术的集合体，俗称微服务全家桶

###1.2SpringCloude和SpringBoot是什么关系？
- SpringBoot专注于快速方便的开发单个个体微服务。
- SpringCloud是关注全局的微服务协调整理治理框架，它将SpringBoot开发的一个个
单体服务整合并管理起来，为各个微服务之间提供，配置管理、服务发现、断路器、
路由、微代理、事件总线、全局锁、决策竞选、分布式会话等等集成服务
- SpringBoot可以离开SpringCloud独立使用，但是SpringCloud离不开SpringBoot,
属于依赖的关系。
- SpringBoot专注于快速、方便的开发单个微服务个体，SpringCloud关注全局的服务
治理框架。

##2.常用组件
###2.1Eureka 注册中心
自我保护模式中，Eureka Server会保护服务注册表中的信息，不再注销任何服务实例。
当它收到的心跳数恢复到阈值以上时，该Eureka Server节点就会自动退出自我保护模
式。它的设计哲学就是宁可保留错误的服务注册信息，也不盲目注销任何可能健康的服
务实例。一句讲解：好死不如赖活着。

关系型数据库（ACID）：
- A（Atomicity）原子性
- C（Consistency）一致性
- I（Isolation）独立性
- D（Durability）持久性
	
非关系型数据库（CAP）：
- C（Consistency）强一致性
- A（Availability）可用性
- P（Partition tolerance）分区容错性

**Zookeeper保证CP：**  
向当前注册中心查询服务列表时，我们可以容忍注册中心返回的是几分钟以前的注册信息，
但不能接受服务直接down掉不可用。也就是说，服务注册功能对可用性的要求高于一致
性。但是zk会出现这样一种情况，当master节点因为网络故障与其他节点失去联系时，剩
余节点会重新进行leader选举。问题在于leader的时间太长，30~120s，且选举期间整个
zk集群是不可用的，这就导致在选举期间注册服务瘫痪。在云部署的环境下，因网络问题
使的zk集群失去master节点是较大概率会发生的事，虽然服务能够最终恢复，但是漫长的
选举时间导致的注册长期不可用是不能容忍的。

**Eureka保证AP：**  
Eureka看明白了这一点，因此在设计时就优先保证可用性。Eureka各个节点都是平等的，
几个节点挂掉不会影响正常节点的工作，剩余的节点依然可以提供注册和服务查询服务。而
Eureka注册时如果发现连接失败，则会自动切换至其他节点，只要有一台Eureka还在，就
能保证注册服务可用（保证可用性），只不过查到的信息可能不是最新的（不保证强一致性
）。除此之外，Eureka还有一种自我保护机制，如果15分钟内超过85%的节点都没有正常
的心跳，那么Eureka就认为客户端与注册中心出现了网络故障，此时会出现以下几种情况：
1. Eureka不再从注册列表中移除因为长时间没有收到心跳而应该过期的的服务
2. Eureka仍然能够接受新服务的注册和查询请求，但是不会被同步到其他节点上（即保证
当前节点依然可用）
3. 当网络稳定时，当前实例新的注册信息会被同步到其他节点中
因此，Eureka可以很好的应对因网络故障导致部分节点失去联系的情况，而不会像zookeeper
那样使整个注册服务瘫痪。

###2.2Ribbon 负载均衡
简单的说，Ribbon是Netflix发布的开源项目，主要功能是提供客户端的软件负载均衡算法，将
Netflix的中间层服务连接在一起。Ribbon客户端组件提供一系列的配置项如连接超时，重试等。
简单的说，就是在配置文件中列出Load Balancer（简称LB）后面所有的机器，Ribbon会自动
的帮助你基于某种规则（如简单轮询，随机连接等）去连接这些机器。我们也很容易使用Ribbon
实现负载均衡算法。
	
###2.3Feign 服务调用
Feign是一个声明式WebService客户端。使用Feign能让编写Web Service客户端更加简单，
它的使用方法是定义一个接口，然后在上面添加注解，同时也支持JAX-RS标准的注解。Feign也
支持可拔插式的编码器和解码器。Spring Cloud对Feign进行了封装，使其支持了
Spring MVC标准注解和HttpMessageConverters。Feign可以与Eureka和Ribbon组合使用
以支持负载均衡。

###2.4Hystix 熔断器
Hystrix是一个用于处理分布式系统的延迟和容错的开源库，在分布式系统里，许多
依赖不可避免的会调用失败，比如超时、异常等等，Hystrix能够保证在一个依赖出
问题的情况下，不会导致整体服务失败，避免级联故障，以提高分布式系统的弹性。

‘断路器’本身是一种开关装置，当某个服务单元发生故障之后，通过断路器的故障
监控（类似熔断保险丝），向调用方返回一个符合预期的、可处理的备选响应
（FallBack）,而不是长时间的等待或者抛出调用方无法处理的异常，这样就保证了服
务调用方的线程不会被长时间、不必要地占用，从而避免了故障在分布式系统中的蔓
延，乃至雪崩。

**服务降级：**  
是我们做了服务降级处理，让客户端不可用时也会获得提示信息而不会挂起耗死服务器。

**服务熔断：**  
是当服务可用，但程序在运行时出现异常，不能成功返回数据时，返回的用户可接受、带
有提示意义的数据（相当于保险丝）

**豪猪：**  
除了隔离依赖服务的调用以外，Hystrix还提供了准实时的调用监控（Hystrix Dashboard）,
Hystrix会持续地记录所有通过Hystrix发起的执行信息，并以统计报表的形式展示给用户，包括每
秒执行多少请求多少成功，多少失败等。  
Netflix通过hystrix-metrics-event-stream项目实现了对以上指标的监控。Spring Cloud也提供
了Hystrix Dashboard的整合，对监控内容转化成可视化界面。  

使用步骤：  
1. 打开豪猪主页（http://localhost:9001/hystrix）
2. 输入要监控的提供者服务（http://localhost:8001/hystrix.stream）
3. 输入有效时效，输入titile(非必须)
4. 点击按钮进行监控

**参数说明：**  
1. Delay:该参数用来控制服务器上轮询信息的延迟时间，默认为2000毫秒，可以通过配置该
属性来降低客户端的网络和cpu消耗。
2. Title:该参数对应了头部标题Hystrix Stream之后的内容，默认会使用具体监控实例的URL，
可以通过该信息来展示更合适的标题。

**如何看？**  
7色，1圈，1线。  
实心圆：共有两种含义。他通过颜色的变化代表了实例的健康程度，他的健康从绿色<黄色<
橙色<红色递减。  
该实心圆除了颜色的变化之外，他的大小也会根据实例的请求流量发生变化，流量越大该实心
圆就越大。所以通过该实心圆的展示，就可以在大量的实例中快速的发现故障实例和高压力实例。

###2.5Zuul 网关
Zuul包含了对请求的路由和过滤两个最主要的功能。  
其中路由功能负责将外部请求转发到具体的微服务实例上，是实现外部访问统一入口的基础而
过滤器功能负责对请求的处理过程进行干预，是实现请求效验、服务聚合等功能的基础。
Zuul自身注册为Eureka服务治理下的应用，同时从Eureka中获得其他微服务的消息，也即以
后的访问微服务都通过Zuul跳转后获得。  
**注意**：Zuul服务最终还是会注册进Eureka

###2.6Config 分布式配置中心
**是什么？**  
为微服务架构中的微服务提供集中化的外部配置支持，配置服务器为各个不同微服务
应用的所有环境提供了一个中心化的外部配置。

**怎么玩：**  
SpringCloud Config分为服务端和客户端两部分。  
服务端也成称为分布式配置中心，它是一个独立的微服务应用，用来连接配置服务器并为客户端提供
获取配置信息，加密/解密信息等访问接口。

**能干嘛？**  
1. 集中管理配置文件
2. 不同环境不同配置，动态化的配置更新，分环境部署比如：dev/test/prod/release
3. 运行期间动态调整配置，不再需要在每个服务部署的机器上编写配置文件，服务会
向配置中心统一拉取配置自己的信息
4. 当配置发生变动时，服务不需要重启即可感知到配置变化的变化并应用新的配置
5. 将配置信息以REST接口的形式暴露

**与GitHub整合配置** 
由于SpringCloud Config默认使用Git来存储配置文件（也有其他方式，比如支持SVN和本地
文件），但是推荐的还是Git,而且使用的时http/https访问的形式

**配置文件生效优先级**  
application.yml是用户级的资源配置项
bootstrap.yml是系统级的，优先级更加高

SpringCloud会创建一个“Bootstrap Context”，作为Spring应用的“Application Contest”的父上下
文。初始化的时候，“Bootstrap Context”负责从外部源加载配置属性并解析配置。这两个上下文共享一个从外部
获取的“Environment”。“Bootstrap”属性有高优先级，默认情况下，他们不会被本地配置覆盖。“Bootstrap
 context”和“Application Context”有着不同的约定，
所以增加一个“bootstrap.yml”文件，保证“Bootstrap Context”和“Application Context”配置的分离。
